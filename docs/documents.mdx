The Documents service provides applications with the ability to store and retrieve application state.
Nitric provides an expressive Document API to make this process as easy as possible.

The Document service is provides a common programming interface across key Cloud document databases
including AWS DynamoDB and GCP Firestore.

> Support for Azure Cosmos and MongoDB is on the roadmap

## Key concepts

### Documents

Documents are the unit of storage within a collection. They are a lightweight record that contains set of fields.
Each document is identified by a unique id string.

For example an actor document with the id `robert.downey@mavel.io` might look like this:

```json
📄 robert.downey@nitric.io
{
  "email": "robert.downey@mavel.io",
  "firstName": "Robert",
  "lastName": "Downey",
}
```

Documents can also nest complex JSON objects like maps or arrays.

```json
📄 robert.downey@mavel.io
{
  "email": "robert.downey@mavel.io",
  "firstName": "Robert",
  "lastName": "Downey",
  "born": 1965,
  "active": true,
  "address": {
		"firstLine":  "Unit A",
		"secondLine": "10 Pearls Street",
		"city":       "Boulder",
		"state":      "CO",
		"zipCode":    80302,
	},
	"contactPrefs": [
		"email",
		"sms",
	],
}
```

### Collections

Collections provide containers for documents. In SQL database terms a collection equates to a table.

With the Documents service collections are schemaless and each document may contain an arbitary set of fields.
However it is best practice for collections to have a well defined set of fields.

Continuing our example you could have an `Actors` collection for all your actor documents:

```json
🗂️ Actors [
    📄 robert.downey@mavel.io
    {
     "first": "Robert",
     "last": "Downey Jr"
    }
    📄 scarlett.johansson@mavel.io
    {
     "first": "Scarlett",
     "last": "Johansson"
    }
    📄 benedict.cumberbatch@mavel.io
    {
     "first": "Benedict",
     "last": "Cumberbatch"
    }
]
```

#### Stack Definition

To use Collections you need to define them as a resource in a stack file, such as `nitric.yaml`. At the root level of the stack file,
add a collections key, which contains an array of collections.

```yaml
---
collections:
  Actors: ~
```

Collections will be automatically created and configured with sensible defaults by the
Nitric CLI when deploying to a cloud environment and emulated when running and testing locally.

### Subcollections

Subcollections allow you to structure documents hierarchically creating one-to-many parent/child relationships. Subcollections becomes extremely useful when:

- you have a large number child items,
- your application has different query access patterns, or
- when you need to optimize performance or cost.

Consider the example below:

```json
🗂️ Customers
    📄 apple
    	🗂️ Orders
			📄 tsmc-us-16ffp-77ba4c67d6c1
			📄 tsmc-us-16ffp-e1f7ecdef392
			📄 tsmc-us-16ffp-b56b55d5a2f2
    📄 samsung
    	🗂️ Orders
			📄 tsmc-ko-7ff-0ed0e9dd95ca
			📄 tsmc-ko-7ff-4960179100d6
			📄 tsmc-ko-7ff-b003fb8a3f14
```

Here we have a `Customers` collection with relatively small number of documents, but each customer has an `Orders` subcollection containing many
thousands of documents. By using separating Customers and Order data we can efficiently retrieve customer records without having to pull all the
associated order data.

Subcollections also provided with query capabilities, enabling efficient lookups of subcollection documents.

##### Subcollections Limitation

- Nitric currently supports 1 level of subcollections under collections

### References

The Document API provides object references to uniquely identify collection and document locations within a database.
A reference can be created regardless of whether the document or collection exists and does not perform any network calls.

<CodeExamples 
	languages={[
	{
		label: "Node",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/refs.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/refs.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/Refs.java" />

<CodeSnippet snippet="nitrictech/go-sdk/examples/documents/refs.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/Ref.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/Refs.cs" />

</CodeExamples>

## Usage

Use one of the provided Nitric SDKs for your language to work with document collections.

### Get

To retrieve the contents of a document reference its `get()` method. Many of the SDKs provide
methods to marshal documents into typed objects.

<CodeExamples 
	languages={[
	{
		label: "Node.js",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/get.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/get.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/Get.java" />

<CodeSnippet snippet="nitrictech/go-sdk/examples/documents/get.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/Get.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/Get.cs" />

</CodeExamples>

### Set

To add a new document to a collection or update an existing document, use the `set()` method on a document reference.

<CodeExamples 
	languages={[
	{
		label: "Node.js",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/set.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/set.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/Set.java" />

<CodeSnippet snippet="nitrictech/go-sdk/examples/documents/set.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/Set.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/Set.cs" />

</CodeExamples>

> Coming Soon: `set()` options for document merge updates and conditional updates.

##### Set Limitations

With AWS DynamoDB the maximum size of a document you can store is 400 KB. If you expect documents larger than this
we recommend you:

- decompose any large nested structures into document subcollections
- store very large document fields in the Storage Service and keep a storage service `bucket/key` reference in your document

### Delete

To delete a document from a collection, use the `delete()` method.

<CodeExamples 
	languages={[
	{
		label: "Node.js",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/delete.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/delete.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/Delete.java" />

<CodeSnippet snippet="nitrictech/go-sdk/examples/documents/delete.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/Delete.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/Delete.cs" />

</CodeExamples>

When you delete a document any subcollection documents will also be deleted.

### Query

The Query object allows you to retrieve filtered sets of documents from collection and subcollections. The Query object provides a uniform
interface across Cloud document databases.

Queries can be executed with the `fetch()` and `stream()` methods:

- The **fetch** method queries the document collection and fetches the results in batches

- The **stream** method queries the document collection and streams the results one by one

#### Collection Queries

Query objects can be created under collections and are used to access all the documents in that collection.
The example below will fetch all the documents in the 'Customers' collection.

<CodeExamples 
	languages={[
	{
		label: "Node.js",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/query.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/query.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/Query.java" />

<CodeSnippet snippet="nitrictech/examples/documents/query.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/Query.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/Query.cs" />

</CodeExamples>

#### Subcollection Queries

Query objects can also be created under subcollections. There are two types of subcollection queries:

1. Document Subcollection Queries
2. Subcollection Group Queries

##### Document Subcollection Queries

Document subcollection queries can only select the subcollection documents under the parent document:

`collection.document.collection.query`

In the example below we are selecting all `Orders` under the parent `Customers` document with the id `apple`.

<CodeExamples
	languages={[
	{
		label: "Node",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/sub-doc-query.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/sub_doc_query.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/SubDocQuery.java" />

<CodeSnippet snippet="nitrictech/go-sdk/examples/documents/sub_doc_query.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/SubDocQuery.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/SubDocQuery.cs" />

</CodeExamples>

##### Subcollection Group Queries

Subcollection Group queries can select all the documents in the collection subcollection group:

`collection.collection.query`

In the example below we are selecting all `Orders` for all `Customers`.

<CodeExamples 
	languages={[
	{
		label: "Node",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/sub-col-query.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/sub_col_query.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/SubColQuery.java" />

<CodeSnippet snippet="nitrictech/go-sdk/examples/documents/sub_col_query.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/SubColQuery.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/SubColQuery.cs" />

</CodeExamples>

### Where Filter Expressions

Query `where` expressions allow you to filter collection results. These `where` expressions take three parameters;
the document field name to filter on, a comparison operator, and an expression value.

`where( <field>, <operator>, <value> )`

For example:

`where( 'country', '==', 'US' )`

##### Expression Operators

The supported expression operators include:

| **Operator** | **Description**        | **Example**                                |
| ------------ | ---------------------- | ------------------------------------------ |
| `==`         | Equals                 | `.where("status", "==", "active")`         |
| `<`          | Less Than              | `.where("count", "<", 10)`                 |
| `>`          | Greather Than          | `.where("price", "<", 100.0)`              |
| `<=`         | Less Than or Equals    | `.where("count", "<=", 10)`                |
| `>=`         | Greater Than or Equals | `.where("price", ">=", 50.0)`              |
| `startsWith` | Text Value Starts With | `.where("type", "startsWith", "Inverter")` |

Where clause expressions can be chained together creating an implicit `AND` clause filter expression. For example:

`where( 'country', '==', 'US' ).where( 'age', '>=', 21 )`

This equates to the SQL:

`WHERE country = 'US' AND age >= 21`

In the examples below we selecting `Customers` documents where the customer's country is equals to 'US' and
they have an age of 21 or older.

<CodeExamples
	languages={[
	{
		label: "Node",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/query-filter.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/query_filter.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/QueryFilter.java" />

<CodeSnippet snippet="nitrictech/examples/documents/query_filter.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/QueryFilter.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/QueryFilter.cs" />

</CodeExamples>

##### Expression Limitations

To ensure your code is Cloud Portable the following expression limitations are enforced by Nitric's Document Service:

1. only one `==` equality expression is supported in query filter expressions (GCP Firestore limitation)
2. only the `>= AND <=` query filter range combination is supported (AWS DynamoDB limitation)

### Fetch Limits

By default the `fetch()` method will return all the documens in a collection. When working with very large collections this may not be
want you want. With some databases such as DynamoDB they have hard limits and will return an error if more than 1 MB of data has been fetched.

To limit the number of document retrieved use the `limit()` method.

In the example below we are fetching the first 1,000 customer order documents across all customers.

<CodeExamples
	languages={[
	{
		label: "Node.js",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/query-limits.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/query_limits.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/QueryLimits.java" />

<CodeSnippet snippet="nitrictech/go-sdk/examples/documents/query_limits.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/QueryLimits.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/QueryLimits.cs" />

</CodeExamples>

### Paged Results

The Query object supports paginated queries whereby you can page your way through large result sets.
Paged queries are useful for efficiently processing large datasets and supporting paged UX.

To use a paginated query set the page size `limit()`, and then use `pagingToken` returned with your results as input into your
next query with the `pagingFrom()` method. This will enable the next query to continue from where the previous query finished.

The example below selects active 'Customers' paging through the collection in sets of 100 document.

<CodeExamples
	languages={[
	{
		label: "Node.js",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/query-paginated.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/paged_results.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/PagedResults.java" />

<CodeSnippet snippet="nitrictech/examples/documents/paged_results.go" />

<CodeSnippet snippet="nitrictech/php-sdk/examples/documents/PagedResults.php" />

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/documents/PagedResults.cs" />

</CodeExamples>

### Streamed Results

Many of the Nitric SDK support streaming Query results. For these SDK use the `stream()` method
to return documents one by one. Streams can better support functional programming models and
reduce memory usage.

Check your SDK for streaming support.

<CodeExamples
	languages={[
	{
		label: "Node.js",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/documents/query-stream.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/documents/streamed.py" />

<CodeSnippet snippet="nitrictech/java-sdk/src/test/java/examples/documents/Streamed.java" />

<CodeSnippet snippet="nitrictech/go-sdk/examples/documents/stream_results.go" />

<CodeExample lang="php">

```
stream() support is under development...
```

</CodeExample>

<CodeExample lang="c-sharp">

```
stream() support is under development...
```

</CodeExample>
</CodeExamples>

<br />

> Note a GRCP Document Service QueryStream query streaming method will be developed to better support SDKs.
