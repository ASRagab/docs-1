The Nitric Secret service provides a unified programming interface across common Cloud secrets management services. This allows for management and access of secrets such as database passwords,
collection URLs and encryption keys, without embedding those values in configuration files or code. Secrets are generally used to access information in other systems.

Currently supported services include AWS Secrets Manager and GCP Secret Manager.

> Support for Azure Key Vault is also on the roadmap

## Key concepts

### Secrets, Versions and Values

Secrets are a uniquely named resource containing one or more versions. When you access a secret's value you are accessing a particular version of that secret.

The schema below illustrates this for a secret named `db.password` with two versions:

```
+- Secret [ 'db.password' ]
   |
   +- SecretVersion [ '7F5F86D0-D97F-487F-A5A0-11BAAD00F777' ]
   |  |
   |  +- SecretValue [ 'bleak_dearest_hanged_reigns' ]
   |
   +- SecretVersion [ '0581BBD9-C67F-4E8F-849D-38E52CAEE0EB' ]
      |
      +- SecretValue [ 'crummy_goofed_caddy_radiant' ]
```

> Note: the version numbers are for illustration only. Cloud vendors use different version numbering strategies.

Using versioned secrets allows support for password and key rotation policies.

### References and Secret Access

When using the one of the Nitric SDKs, the Secret and SecretVersion objects are light-weight references.

To access the value of a secret (data) you use the SecretVersion `access()` method which will make a server call returning a SecretValue object.

To get the latest version of a secret you use the `latest()` method on the Secret object.

## Usage

Using one of the provided Nitric SDKs for your language is the easiest way to work with Secrets.

### Put

To create a new SecretValue use the Secret `put` method.

<CodeExamples 
	languages={[
	{
		label: "Node",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/secrets/put.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/secrets/put.py" />

<CodeExample lang="java">

```java
import io.nitric.api.secret.Secrets;

var newPassword = "qxGJp9rWMbYvPEsNFXzukQa!";

// Store the new password value, making it the latest version
Secrets.secret("database.password").putAsText(newPassword);
```

</CodeExample>

<CodeSnippet snippet="nitrictech/go-sdk/examples/secrets/put.go" />

<CodeExample lang="php">

```
Secrets support is under development...
```

</CodeExample>

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/secrets/Put.cs" />

</CodeExamples>

The `put` method will return a SecretValue object which has a reference to the newly created SecretVersion.

##### Put Limitations

The maximium secret value size you can store is 24 KB. This limit ensures your code is compatiable across Cloud providers.

### Latest

To access the latest version of a Secret you use the `latest()` method.

<CodeExamples 
	languages={[
	{
		label: "Node",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/secrets/latest.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/secrets/latest.py" />

<CodeExample lang="java">

```java
import io.nitric.api.secret.Secrets;

var version = Secrets.secret("database.password").latest();
```

</CodeExample>

<CodeSnippet snippet="nitrictech/go-sdk/examples/secrets/latest.go" />

<CodeExample lang="php">

```
Secrets support is under development...
```

</CodeExample>

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/secrets/Latest.cs" />

</CodeExamples>

Note the `latest` SecretVersion reference is an alias to access the latest SecretValue. Making repeated `access()` calls from this latest version may return different secret values if a new version is created between calls.

To get the actual or materialized SecretVersion for a SecretValue, use the SecretValue object's SecretVersion property.

### Access

To access the value (data) of a secret version use the `access()` method.

<CodeExamples 
	languages={[
	{
		label: "Node",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>

<CodeSnippet snippet="nitrictech/node-sdk/examples/secrets/access.ts" />

<CodeSnippet snippet="nitrictech/python-sdk/examples/secrets/access.py" />

<CodeExample lang="java">

```java
import io.nitric.api.secret.Secrets;

var value = Secrets.secret("database.password")
	.latest()
	.access();

var password = value.getAsText();
```

</CodeExample>

<CodeSnippet snippet="nitrictech/go-sdk/examples/secrets/access.go" />

<CodeExample lang="php">

```
Secrets support is under development...
```

</CodeExample>

<CodeSnippet snippet="nitrictech/dotnet-sdk/examples/secrets/Access.cs" />

</CodeExamples>

The SecretValue is a value object containing the secret data and the SecretVersion the data was retrieved from.

## Examples

### Encryption Data Keys

This example uses the Secrets API to store a data encryption key. This key is used to encrypt and decrypt PII data records (Personally Identifying Information).
The encryption key's secret name and secret version are stored with the PII record so that the data key can be retrieved from the Secrets API at some later point to decrypt the PII record.

Using this strategy individual records can have their own data encryption key which limits PII data exposure if an individual key is compromised.

<CodeExamples 
	languages={[
	{
		label: "Node",
		value: "node"
	},
	{
		label: "Python",
		value: "python"
	},
	{
		label: "Java",
		value: "java"
	},
	{
		label: "Go",
		value: "go"
	},
	{
		label: "PHP",
		value: "php"
	},
	{
		label: "C#",
		value: "c-sharp"
	}
	]}
	defaultLang="node"
>
<CodeExample lang="node">

```typescript
import { storage } from '@nitric/sdk';

const secrets = new Secrets();

 // Store a new AES-256 secret data 'encryption.key'
 var dataKey = ...
 secrets.secret("encryption.key").put(dataKey);

// Sometime later lookup latest version of 'encryption.key' and use this to
// encrypt a private record. Note we store the secret key name and version
// with the record so we can use this later to decrypt the record.
 var value = secrets.secret("encryption.key")
    .latest()
    .access();

 var dataKey = value.asBytes();

 // Here we encrypt the PII data with encryption data key
 var encryptedData = ...

 var record = new PiiRecord();
 record.setEncryptedData(encryptedData);
 record.setKeyName(value.secretVersion.secret.name);
 record.setKeyVersion(value.secretVersion.version);

 // Retrieve a customer PII record
 var custRecord = ...

 var custKey = secrets.secret(custRecord.getKeyName())
    .version(custRecord.getKeyVersion())
    .access()
    .asBytes();

 // Use the encryption key to decrypt the records PII data
```

</CodeExample>
<CodeExample lang="python">

```python
from nitric.api import Secrets

secrets = Secrets()

# Store a new AES-256 secret data 'encryption.key'
data_key = ...
secrets.secret("encryption.key").put(data_key)

# Sometime later lookup latest version of 'encryption.key' and use this to
# encrypt a private record. note we store the secret key name and version
# with the record so we can use this later to decrypt the record.
secret = await secrets.secret("encryption.key").latest().access()

dataKey = secret.as_bytes()

# Here we encrypt the PII data with encryption data key
encrypted_data = ...

record = PIIRecord()
record.set_encrypted_data(encrypted_data)
record.set_key_name(secret.version.secret.name)
record.set_key_version(secret.version.id)

# Retrieve a customer PII record
cust_record = ...
cust_key = await (secrets.secret(cust_record.get_key_name())
									.version(cust_record.get_key_version)
									.access())
cust_key = cust_key.as_bytes()

```

</CodeExample>
<CodeExample lang="java">

```java
import io.nitric.api.secret.Secrets;
import io.nitric.api.secret.SecretValue;
import com.example.entity.PiiRecord;


// Store a new AES-256 secret data 'encryption.key'
byte[] dataKey = ...
Secrets.secret("encryption.key").put(dataKey);

// Sometime later lookup latest version of 'encryption.key' and use this to
// encrypt a private record. Note we store the secret key name and version
// with the record so we can use this later to decrypt the record.
SecretValue value = Secrets.secret("encryption.key")
  .latest()
  .access();

byte[] dataKey = value.get();

// Here we encrypt the PII data with encryption data key
byte[] encryptedData = ...

var record = new PiiRecord();
record.setEncryptedData(encryptedData);
record.setKeyName(value.getSecretVersion().getSecret().getName());
record.setKeyVersion(value.getSecretVersion().getVersion());

// Retrieve a customer PII record
PiiRecord custRecord = ...

byte[] custKey = Secrets.secret(custRecord.getKeyName())
  .version(custRecord.getKeyVersion())
  .access()
  .get();

// Use the encryption key to decrypt the records PII data
```

</CodeExample>
<CodeExample lang="go">

```go
import (
    "github.com/nitrictech/go-sdk/api/secrets"
)

ss, err := secrets.New()

if err != nil {
	// handle error
}

// Store a new AES-256 secret data 'encryption.key'
dataKey := ...
_, err := secrets.Secret("encryption.key").Put(dataKey);

if err != nil {
	// handle error
}

// Sometime later lookup latest version of 'encryption.key' and use this to
// encrypt a private record. Note we store the secret key name and version
// with the record so we can use this later to decrypt the record.
value, err := secrets.Secret("encryption.key")
	.Latest()
    .Access();

if err != nil {
	// handle error
}

dataKey := value.Value;

// Here we encrypt the PII data with encryption data key
encryptedData := ...

record := PiiRecord{
	EncryptedData: encryptedData,
	KeyName:       value.SecretVersion.Secret.Name,
	KeyVersion:    value.SecretVersion.Version,
}

// Retrieve a customer PII record
custRecord := ...

value, err := secrets.Secret(custRecord.KeyName)
    .Version(custRecord.KeyVersion)
    .Access();

if err != nil {
	// handle error
}

custKey := value.AsBytes()

// Use the encryption key to decrypt the records PII data
```

</CodeExample>
<CodeExample lang="php">

```
Secrets support is under development...
```

</CodeExample>

<CodeExample lang="c-sharp">

```csharp
using Nitric.Api.Secret;
using com.example.entity.PiiRecord;
...

var secrets = new Secrets();

// Store a new AES-256 secret data 'encryption.key'
byte[] dataKey = ...
secrets.Secret("encryption.key").Put(dataKey);

// Sometime later lookup latest version of 'encryption.key' and use this to
// encrypt a private record. Note we store the secret key name and version
// with the record so we can use this later to decrypt the record.
SecretValue value = secrets.Secret("encryption.key")
	.Latest()
    .Access();

byte[] dataKey = value.Value;

// Here we encrypt the PII data with encryption data key
byte[] encryptedData = ...

var record = new PiiRecord();
record.SetEncryptedData(encryptedData);
record.SetKeyName(value.SecretVersion.Secret.Name);
record.SetKeyVersion(value.SecretVersion.Version);

// Retrieve a customer PII record
PiiRecord custRecord = ...

byte[] custKey = secrets.Secret(custRecord.GetKeyName())
    .Version(custRecord.GetKeyVersion())
    .Access()
    .Value;

// Use the encryption key to decrypt the records PII data
```

</CodeExample>

</CodeExamples>
